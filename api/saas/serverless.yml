service: autonomia-api-saas

frameworkVersion: '3'

plugins:
  - serverless-domain-manager

custom:
  # Mapeamento stage backend-saas -> stage financial-service (para invocação Lambda)
  financialServiceStageMap:
    prod: production
    staging: staging
  financialServiceStage: ${self:custom.financialServiceStageMap.${self:provider.stage}, self:provider.stage}
  customDomain:
    domainName: api-saas.autonomia.site
    basePath: ''
    stage: ${opt:stage, 'staging'}
    certificateId: 'cee74474-da0c-4aba-b9f7-3759e4eddd7e'
    createRoute53Record: false
    endpointType: 'edge'
  authorizer:
    name: cognitoAuthorizer
    type: COGNITO_USER_POOLS
    identitySource: method.request.header.Authorization
    arn: !ImportValue autonomia-api-auth-${self:provider.stage}-UserPoolArn

layers:
  commonLibs:
    path: layers/common
    name: ${self:service}-${self:provider.stage}-common
    compatibleRuntimes:
      - nodejs18.x

package:
  individually: true
  patterns:
    - '!**/*.map'
    - '!**/*.md'
    - '!test/**'
    - '!tests/**'
    - '!**/.env*'
    - '!package-lock.json'
    - '!**/.npmrc'
    - '!node_modules/**'
    - '!dist/**'
    - '!layers/**'

provider:
  name: aws
  runtime: nodejs18.x

  stage: ${opt:stage, 'staging'}
  region: us-east-1
  memorySize: 512
  timeout: 30
  layers:
    - { Ref: CommonLibsLambdaLayer }
  vpc:
    securityGroupIds:
      - 'sg-0e9189ca9e6d0427d'
    subnetIds:
      - 'subnet-07184b6cfa97367e2'
      - 'subnet-000fbcffe0f8d9a11'
  environment:
    NODE_ENV: ${self:provider.stage}
    DB_HOST: ${ssm:/autonomia/${self:provider.stage}/db/host, 'autonomia-prod-db.cde6ocsqc6dk.us-east-1.rds.amazonaws.com'}
    DB_PORT: ${ssm:/autonomia/${self:provider.stage}/db/port, '5432'}
    DB_NAME: ${ssm:/autonomia/${self:provider.stage}/db/name, 'autonomia_db'}
    DB_USER: ${ssm:/autonomia/${self:provider.stage}/db/user, 'autonomia_admin'}
    DB_PASSWORD: ${ssm:/autonomia/${self:provider.stage}/db/password, ''}
    DB_SSL_ENABLED: ${ssm:/autonomia/${self:provider.stage}/db/ssl-enabled, 'false'}
    REDIS_HOST: ${ssm:/autonomia/${self:provider.stage}/redis/host, ''}
    REDIS_PORT: ${ssm:/autonomia/${self:provider.stage}/redis/port, '6379'}
    CACHE_TTL: ${ssm:/autonomia/${self:provider.stage}/cache/ttl, '300'}
    N8N_WEBHOOK_URL: ${ssm:/autonomia/${self:provider.stage}/n8n/webhook-url, 'https://auto.autonomia.site/workflow/AEuLu99AOhpofmhJ'}
    KNOWLEDGE_BUCKET: ${ssm:/autonomia/${self:provider.stage}/knowledge/bucket, 'autonomia-knowledge-docs'}
    KNOWLEDGE_PUBLIC_BASE: ${ssm:/autonomia/${self:provider.stage}/knowledge/public-base, 'https://autonomia-knowledge-docs.s3.amazonaws.com'}
    EVS_PRODUCT_ID: ${ssm:/autonomia/saas/EVS_PRODUCT_ID, ''}
    EUVIAJO_CLIENT_API_TOKEN: ${ssm:/autonomia/saas/EUVIAJO_CLIENT_API_TOKEN, ''}
    # URL do financial-service (usado só se invocação Lambda não estiver configurada). Para sincronizar: no repo financial-service execute ./scripts/sync-financial-api-url-ssm.sh production prod us-east-1.
    FINANCIAL_SERVICE_URL: ${ssm:/financial-service/${self:provider.stage}/api-url, ''}
    # Invocação direta da Lambda do financial-service (evita HTTP; Lambdas em VPC sem NAT não alcançam API Gateway). Backend stage prod -> financial stage production.
    FINANCIAL_SERVICE_CREATE_SUBSCRIPTION_FUNCTION: fin-account-subscriptions-${self:custom.financialServiceStage}-createAccountSubscription
    FINANCIAL_SERVICE_ASSOCIATE_ONBOARDING_FUNCTION: fin-account-subscriptions-${self:custom.financialServiceStage}-associateOnboardingData
  iamRoleStatements:
    - Effect: Allow
      Action:
        - rds:*
      Resource: "*"
    - Effect: Allow
      Action:
        - ec2:CreateNetworkInterface
        - ec2:DescribeNetworkInterfaces
        - ec2:DeleteNetworkInterface
      Resource: "*"
    - Effect: Allow
      Action:
        - ssm:GetParameter
      Resource:
        - "arn:aws:ssm:us-east-1:*:parameter/autonomia/*"
        - "arn:aws:ssm:us-east-1:*:parameter/financial-service/*"
    - Effect: Allow
      Action: lambda:InvokeFunction
      Resource:
        - "arn:aws:lambda:us-east-1:*:function:fin-account-subscriptions-${self:custom.financialServiceStage}-createAccountSubscription"
        - "arn:aws:lambda:us-east-1:*:function:fin-account-subscriptions-${self:custom.financialServiceStage}-associateOnboardingData"
    - Effect: Allow
      Action:
        - elasticache:*
      Resource: "*"
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:PutObjectAcl
      Resource:
        - arn:aws:s3:::${ssm:/autonomia/${self:provider.stage}/knowledge/bucket, 'autonomia-knowledge-docs'}/*

functions:
  listProducts:
    handler: handlers/list-products.handler
    events:
      - http:
          path: Autonomia/Saas/Products
          method: get
          cors: true
          authorizer: ${self:custom.authorizer}

  listProductTypes:
    handler: handlers/list-product-types.handler
    events:
      - http:
          path: Autonomia/Saas/ProductTypes
          method: get
          cors: true
          authorizer: ${self:custom.authorizer}
          
  getProduct:
    handler: handlers/get-product.handler
    events:
      - http:
          path: Autonomia/Saas/Products/{productId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                productId: true
          authorizer: ${self:custom.authorizer}
          
  createProduct:
    handler: handlers/create-product.handler
    events:
      - http:
          path: Autonomia/Saas/Products
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}
          
  updateProduct:
    handler: handlers/update-product.handler
    events:
      - http:
          path: Autonomia/Saas/Products/{productId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                productId: true
          authorizer: ${self:custom.authorizer}
          
  deleteProduct:
    handler: handlers/delete-product.handler
    events:
      - http:
          path: Autonomia/Saas/Products/{productId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                productId: true
          authorizer: ${self:custom.authorizer}

  # Knowledge Documents
  listKnowledgeDocuments:
    handler: handlers/list-knowledge-documents.handler
    events:
      - http:
          path: Autonomia/Saas/KnowledgeDocuments
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                accountId: false
          authorizer: ${self:custom.authorizer}

  getKnowledgeDocument:
    handler: handlers/get-knowledge-document.handler
    events:
      - http:
          path: Autonomia/Saas/KnowledgeDocuments/{documentId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                documentId: true
          authorizer: ${self:custom.authorizer}

  createKnowledgeDocument:
    handler: handlers/create-knowledge-document.handler
    events:
      - http:
          path: Autonomia/Saas/KnowledgeDocuments
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}
    vpc: null

  updateKnowledgeDocument:
    handler: handlers/update-knowledge-document.handler
    events:
      - http:
          path: Autonomia/Saas/KnowledgeDocuments/{documentId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                documentId: true
          authorizer: ${self:custom.authorizer}

  deleteKnowledgeDocument:
    handler: handlers/delete-knowledge-document.handler
    events:
      - http:
          path: Autonomia/Saas/KnowledgeDocuments/{documentId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                documentId: true
          authorizer: ${self:custom.authorizer}
    vpc: null

  # Sync Knowledge Document with external RAG processor
  syncKnowledgeDocument:
    handler: handlers/sync-knowledge-document.handler
    events:
      - http:
          path: Autonomia/Saas/KnowledgeDocuments/{documentId}/sync
          method: post
          cors: true
          request:
            parameters:
              paths:
                documentId: true
          authorizer: ${self:custom.authorizer}
    vpc: null

  listAccounts:
    handler: handlers/list-accounts.handler
    events:
      - http:
          path: Autonomia/Saas/Accounts
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
              - X-Amz-Security-Token
            allowCredentials: true
          request:
            parameters:
              querystrings:
                productId: false
                domain: false
          authorizer: ${self:custom.authorizer}

  getUserPermissions:
    handler: handlers/get-user-permissions.handler
    description: Retorna permissões do usuário (canSeeAll = admin autonomia) para uso no financial-service
    events:
      - http:
          path: Autonomia/Saas/UserPermissions
          method: get
          cors: true
          authorizer: ${self:custom.authorizer}

  getAccount:
    handler: handlers/get-account.handler
    events:
      - http:
          path: Autonomia/Saas/Accounts/{accountId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                accountId: true
          authorizer: ${self:custom.authorizer}

  createAccount:
    handler: handlers/create-account.handler
    events:
      - http:
          path: Autonomia/Saas/Accounts
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  completeAccountSubscription:
    handler: handlers/complete-account-subscription.handler
    description: Completa assinatura quando o usuário escolhe o plano após criar conta (subscriptionPlanRequired)
    events:
      - http:
          path: Autonomia/Saas/Accounts/CompleteSubscription
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateAccount:
    handler: handlers/update-account.handler
    events:
      - http:
          path: Autonomia/Saas/Accounts/{accountId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                accountId: true
          authorizer: ${self:custom.authorizer}

  deleteAccount:
    handler: handlers/delete-account.handler
    events:
      - http:
          path: Autonomia/Saas/Accounts/{accountId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                accountId: true
          authorizer: ${self:custom.authorizer}

  listProductParameters:
    handler: handlers/list-product-parameters.handler
    events:
      - http:
          path: Autonomia/Saas/ProductParameters
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                productId: true
          authorizer: ${self:custom.authorizer}

  getProductParameter:
    handler: handlers/get-product-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/ProductParameters/{parameterId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                parameterId: true
          authorizer: ${self:custom.authorizer}

  createProductParameter:
    handler: handlers/create-product-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/ProductParameters
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateProductParameter:
    handler: handlers/update-product-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/ProductParameters/{parameterId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                parameterId: true
          authorizer: ${self:custom.authorizer}

  deleteProductParameter:
    handler: handlers/delete-product-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/ProductParameters/{parameterId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                parameterId: true
          authorizer: ${self:custom.authorizer}

  listAgentPrompts:
    handler: handlers/list-agent-prompts.handler
    events:
      - http:
          path: Autonomia/Saas/AgentPrompts
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                productId: true
          authorizer: ${self:custom.authorizer}

  getAgentPrompt:
    handler: handlers/get-agent-prompt.handler
    events:
      - http:
          path: Autonomia/Saas/AgentPrompts/{promptId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                promptId: true
          authorizer: ${self:custom.authorizer}

  createAgentPrompt:
    handler: handlers/create-agent-prompt.handler
    events:
      - http:
          path: Autonomia/Saas/AgentPrompts
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateAgentPrompt:
    handler: handlers/update-agent-prompt.handler
    events:
      - http:
          path: Autonomia/Saas/AgentPrompts/{promptId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                promptId: true
          authorizer: ${self:custom.authorizer}

  deleteAgentPrompt:
    handler: handlers/delete-agent-prompt.handler
    events:
      - http:
          path: Autonomia/Saas/AgentPrompts/{promptId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                promptId: true
          authorizer: ${self:custom.authorizer}

  reactivateAgentPrompt:
    handler: handlers/reactivate-agent-prompt.handler
    events:
      - http:
          path: Autonomia/Saas/AgentPrompts/{promptId}/reactivate
          method: post
          cors: true
          request:
            parameters:
              paths:
                promptId: true
          authorizer: ${self:custom.authorizer}

  listAgentPromptsStandard:
    handler: handlers/list-agent-prompts-standard.handler
    events:
      - http:
          path: Autonomia/Saas/AgentPromptsStandard
          method: get
          cors: true
          authorizer: ${self:custom.authorizer}

  listAccountParameters:
    handler: handlers/list-account-parameters.handler
    events:
      - http:
          path: Autonomia/Saas/AccountParameters
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                accountId: true
          authorizer: ${self:custom.authorizer}

  getAccountParameter:
    handler: handlers/get-account-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/AccountParameters/{parameterId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                parameterId: true
          authorizer: ${self:custom.authorizer}

  createAccountParameter:
    handler: handlers/create-account-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/AccountParameters
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateAccountParameter:
    handler: handlers/update-account-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/AccountParameters/{parameterId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                parameterId: true
          authorizer: ${self:custom.authorizer}

  deleteAccountParameter:
    handler: handlers/delete-account-parameter.handler
    events:
      - http:
          path: Autonomia/Saas/AccountParameters/{parameterId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                parameterId: true
          authorizer: ${self:custom.authorizer}

  listAccountParametersStandard:
    handler: handlers/list-account-parameters-standard.handler
    events:
      - http:
          path: Autonomia/Saas/AccountParametersStandard
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                visibleOnboarding: false
          authorizer: ${self:custom.authorizer}

  createAccountOnboarding:
    handler: handlers/create-account-onboarding.handler
    timeout: 60
    events:
      - http:
          path: Autonomia/Saas/Onboarding/Accounts
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  evsPartialRegister:
    handler: handlers/evs-partial-register.handler
    events:
      - http:
          path: Autonomia/Saas/EVS/PartialRegister
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}
    vpc: null

  listProductParametersStandard:
    handler: handlers/list-product-parameters-standard.handler
    events:
      - http:
          path: Autonomia/Saas/ProductParametersStandard
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                visibleOnboarding: false
          authorizer: ${self:custom.authorizer}

  getProductParametersForOnboarding:
    handler: handlers/get-product-parameters-for-onboarding.handler
    events:
      - http:
          path: Autonomia/Saas/Products/{productId}/ParametersOnboarding
          method: get
          cors: true
          request:
            parameters:
              paths:
                productId: true
          authorizer: ${self:custom.authorizer}

  getAccountParametersForOnboarding:
    handler: handlers/get-account-parameters-for-onboarding.handler
    events:
      - http:
          path: Autonomia/Saas/Accounts/{accountId}/ParametersOnboarding
          method: get
          cors: true
          request:
            parameters:
              paths:
                accountId: true
          authorizer: ${self:custom.authorizer}

  listConversationFunnels:
    handler: handlers/list-conversation-funnels.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnels
          method: get
          cors: true
          authorizer: ${self:custom.authorizer}

  getConversationFunnel:
    handler: handlers/get-conversation-funnel.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnels/{funnelId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                funnelId: true
          authorizer: ${self:custom.authorizer}

  createConversationFunnel:
    handler: handlers/create-conversation-funnel.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnels
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateConversationFunnel:
    handler: handlers/update-conversation-funnel.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnels/{funnelId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                funnelId: true
          authorizer: ${self:custom.authorizer}

  deleteConversationFunnel:
    handler: handlers/delete-conversation-funnel.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnels/{funnelId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                funnelId: true
          authorizer: ${self:custom.authorizer}

  listConversationFunnelSteps:
    handler: handlers/list-conversation-funnel-steps.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelSteps
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                accountId: true
          authorizer: ${self:custom.authorizer}

  getConversationFunnelStep:
    handler: handlers/get-conversation-funnel-step.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelSteps/{stepId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                stepId: true
          authorizer: ${self:custom.authorizer}

  createConversationFunnelStep:
    handler: handlers/create-conversation-funnel-step.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelSteps
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateConversationFunnelStep:
    handler: handlers/update-conversation-funnel-step.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelSteps/{stepId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                stepId: true
          authorizer: ${self:custom.authorizer}

  deleteConversationFunnelStep:
    handler: handlers/delete-conversation-funnel-step.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelSteps/{stepId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                stepId: true
          authorizer: ${self:custom.authorizer}

  listConversationFunnelStepMessages:
    handler: handlers/list-conversation-funnel-step-messages.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelStepMessages
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                accountId: true
          authorizer: ${self:custom.authorizer}

  getConversationFunnelStepMessage:
    handler: handlers/get-conversation-funnel-step-message.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelStepMessages/{messageId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                messageId: true
          authorizer: ${self:custom.authorizer}

  createConversationFunnelStepMessage:
    handler: handlers/create-conversation-funnel-step-message.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelStepMessages
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateConversationFunnelStepMessage:
    handler: handlers/update-conversation-funnel-step-message.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelStepMessages/{messageId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                messageId: true
          authorizer: ${self:custom.authorizer}

  deleteConversationFunnelStepMessage:
    handler: handlers/delete-conversation-funnel-step-message.handler
    events:
      - http:
          path: Autonomia/Saas/ConversationFunnelStepMessages/{messageId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                messageId: true
          authorizer: ${self:custom.authorizer}

  # Inbox CRUD
  listInboxes:
    handler: handlers/list-inboxes.handler
    events:
      - http:
          path: Autonomia/Saas/Inboxes
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                accountId: true
          authorizer: ${self:custom.authorizer}

  getInbox:
    handler: handlers/get-inbox.handler
    events:
      - http:
          path: Autonomia/Saas/Inboxes/{inboxId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                inboxId: true
          authorizer: ${self:custom.authorizer}

  createInbox:
    handler: handlers/create-inbox.handler
    events:
      - http:
          path: Autonomia/Saas/Inboxes
          method: post
          cors: true
          authorizer: ${self:custom.authorizer}

  updateInbox:
    handler: handlers/update-inbox.handler
    events:
      - http:
          path: Autonomia/Saas/Inboxes/{inboxId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                inboxId: true
          authorizer: ${self:custom.authorizer}

  deleteInbox:
    handler: handlers/delete-inbox.handler
    events:
      - http:
          path: Autonomia/Saas/Inboxes/{inboxId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                inboxId: true
          authorizer: ${self:custom.authorizer}

  # Kanban items (moved from funnel to saas)
  listKanbanItems:
    handler: handlers/list-kanban-items.handler
    events:
      - http:
          path: Autonomia/Saas/KanbanItems
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                accountId: false
          authorizer: ${self:custom.authorizer}

  updateKanbanItem:
    handler: handlers/update-kanban-item.handler
    events:
      - http:
          path: Autonomia/Saas/KanbanItems/{itemId}
          method: put
          cors: true
          request:
            parameters:
              paths:
                itemId: true
          authorizer: ${self:custom.authorizer}

  n8nWebhook:
    handler: handlers/n8n-webhook.handler
    events:
      - http:
          path: Autonomia/Saas/Webhooks/n8n
          method: post
          cors: true
          # Note: No authorizer for webhook endpoint

  getUserSessionAgentMessageStats:
    handler: handlers/get-user-session-agent-message-stats.handler
    events:
      - http:
          path: Autonomia/Saas/UserSessionAgentMessages/Stats
          method: get
          cors: true
          request:
            parameters:
              querystrings:
                accountId: true
                startDate: true
                endDate: true
          authorizer: ${self:custom.authorizer}
